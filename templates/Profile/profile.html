<!DOCTYPE html>
<html lang="ru">
{% load static %}
<head>
    <title>{% block title %} Welcome {% endblock %}</title>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="csrf-token" content="{{ csrf_token }}">
    <link rel="stylesheet" href="{% static 'Profile/css/main.css' %}">
</head>
<body>
    <div class="Header">
        <h1 class="title">Rhytmify</h1>
    </div>

    <div class="profile-container">
        <div class="profile-header">
            <div class="profile-info">
                {% if user.image %}
                    <img src="{{ user.image.url }}" class="profile-image" alt="Profile Picture">
                {% else %}
                    <div class="profile-image-placeholder">{{ user.username|first|upper }}</div>
                {% endif %}
                <div class="profile-details">
                    <span class="profile-type">Профиль</span>
                    <h1 class="profile-name">{{ user.username }}</h1>
                </div>
            </div>
        </div>

        <div class="tabs-container">
            <button class="tab-button active" data-tab="tracks">Топ треки</button>
            <button class="tab-button" data-tab="playlist">Плейлист</button>
            <button class="tab-button" data-tab="stats">Статистика</button>
        </div>

        <div class="tab-content active" id="tracks-tab">
            {% if user.spotify_id %}
                {% if user_favorite_tracks %}
                    <div class="tracks-list">
                        {% for track in user_favorite_tracks %}
                            <div class="track-item">
                                <div class="track-number">{{ forloop.counter }}</div>
                                {% with track.artists.all|first as first_artist %}
                                    {% if first_artist and first_artist.image %}
                                        <img src="{{ first_artist.image.url }}" class="track-image" alt="Track Image">
                                    {% else %}
                                        <div class="track-image-placeholder">♪</div>
                                    {% endif %}
                                {% endwith %}
                                <div class="track-info">
                                    <div class="track-name">
                                        {% if track.url %}
                                            <a href="{{ track.url }}" class="track-name-link" target="_blank">{{ track.name }}</a>
                                        {% else %}
                                            {{ track.name }}
                                        {% endif %}
                                    </div>
                                    <div class="track-artists">
                                        {% if track.artists.all %}
                                            {% for artist in track.artists.all %}
                                                {% if artist.spotify_url %}
                                                    <a href="{{ artist.spotify_url }}" class="artist-link" target="_blank">{{ artist.name }}</a>
                                                {% else %}
                                                    <span class="artist-name">{{ artist.name }}</span>
                                                {% endif %}
                                                {% if not forloop.last %}, {% endif %}
                                            {% endfor %}
                                        {% else %}
                                            <span class="artist-name">Неизвестный артист</span>
                                        {% endif %}
                                    </div>
                                </div>
                                <div class="track-duration">-</div>
                            </div>
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>У вас пока нет любимых треков</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <p>Подключите Spotify, чтобы увидеть свои любимые треки</p>
                    <a href="{% url 'spotify_login' %}" class="spotify-connect-button">Подключить Spotify</a>
                </div>
            {% endif %}
        </div>

        <div class="tab-content" id="playlist-tab">
            <div class="playlist-section">
                <div class="playlist-header">
                    <button class="create-playlist-button" id="create-playlist-btn">Создать плейлист</button>
                    <div id="playlist-message" class="playlist-message" style="display: none;"></div>
                </div>
                {% if user.spotify_id %}
                    {% if user_recommended_tracks %}
                        <div class="tracks-list">
                            {% for track in user_recommended_tracks %}
                                <div class="track-item">
                                    <div class="track-number">{{ forloop.counter }}</div>
                                    {% with track.artists.all|first as first_artist %}
                                        {% if first_artist and first_artist.image %}
                                            <img src="{{ first_artist.image.url }}" class="track-image" alt="Track Image">
                                        {% else %}
                                            <div class="track-image-placeholder">♪</div>
                                        {% endif %}
                                    {% endwith %}
                                    <div class="track-info">
                                        <div class="track-name">
                                            {% if track.url %}
                                                <a href="{{ track.url }}" class="track-name-link" target="_blank">{{ track.name }}</a>
                                            {% else %}
                                                {{ track.name }}
                                            {% endif %}
                                        </div>
                                        <div class="track-artists">
                                            {% if track.artists.all %}
                                                {% for artist in track.artists.all %}
                                                    {% if artist.spotify_url %}
                                                        <a href="{{ artist.spotify_url }}" class="artist-link" target="_blank">{{ artist.name }}</a>
                                                    {% else %}
                                                        <span class="artist-name">{{ artist.name }}</span>
                                                    {% endif %}
                                                    {% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            {% else %}
                                                <span class="artist-name">Неизвестный артист</span>
                                            {% endif %}
                                        </div>
                                    </div>
                                    <div class="track-duration">-</div>
                                </div>
                            {% endfor %}
                        </div>
                    {% else %}
                        <div class="empty-state">
                            <p>У вас пока нет треков в плейлисте</p>
                        </div>
                    {% endif %}
                {% else %}
                    <div class="empty-state">
                        <p>Подключите Spotify, чтобы создать плейлист</p>
                        <a href="{% url 'spotify_login' %}" class="spotify-connect-button">Подключить Spotify</a>
                    </div>
                {% endif %}
            </div>
        </div>

        <div class="tab-content" id="stats-tab">
            {% if user.spotify_id %}
                {% if user_statistics %}
                    <div class="stats-header">
                        <div class="stats-filters">
                            <div class="filter-group">
                                <label for="stats-year">Год</label>
                                <select id="stats-year"></select>
                            </div>
                            <div class="filter-group">
                                <label for="stats-month">Месяц</label>
                                <select id="stats-month"></select>
                            </div>
                            <button class="show-all-button" id="stats-show-all" type="button">Показать всё</button>
                        </div>
                    </div>

                    <div class="stats-container" id="stats-container">
                        {% for month_data in user_statistics_sorted %}
                            {% with month=month_data.0 data=month_data.1 %}
                                {% with y=month|slice:':4' m=month|slice:'5:' %}
                                <div class="stats-period-block" data-year="{{ y }}" data-month="{{ m }}">
                                {% endwith %}
                                    <div class="stats-period-header">
                                        <h2 class="stats-period-title">{{ month }}</h2>
                                    </div>

                                    <div class="stats-grid">
                                        <!-- Топ треки -->
                                        <div class="stats-card stats-card-tracks">
                                            <div class="stats-card-header">
                                                <h3 class="stats-card-title">Топ треки</h3>
                                                <span class="stats-card-count">{{ data.tracks|length }}</span>
                                            </div>
                                            {% if data.tracks %}
                                                <div class="stats-tracks-list">
                                                    {% for item in data.tracks %}
                                                        <div class="stats-track-item">
                                                            <div class="stats-track-rank">{{ forloop.counter }}</div>
                                                            {% with item.track.artists.all|first as first_artist %}
                                                                {% if first_artist and first_artist.image %}
                                                                    <img src="{{ first_artist.image.url }}" class="stats-track-image" alt="Track Image">
                                                                {% else %}
                                                                    <div class="stats-track-image-placeholder">♪</div>
                                                                {% endif %}
                                                            {% endwith %}
                                                            <div class="stats-track-info">
                                                                <div class="stats-track-name">
                                                                    {% if item.track.url %}
                                                                        <a href="{{ item.track.url }}" class="stats-track-link" target="_blank">{{ item.track.name }}</a>
                                                                    {% else %}
                                                                        {{ item.track.name }}
                                                                    {% endif %}
                                                                </div>
                                                                <div class="stats-track-artists">
                                                                    {% if item.track.artists.all %}
                                                                        {% for artist in item.track.artists.all %}
                                                                            {% if artist.spotify_url %}
                                                                                <a href="{{ artist.spotify_url }}" class="stats-artist-link" target="_blank">{{ artist.name }}</a>
                                                                            {% else %}
                                                                                <span>{{ artist.name }}</span>
                                                                            {% endif %}
                                                                            {% if not forloop.last %}, {% endif %}
                                                                        {% endfor %}
                                                                    {% else %}
                                                                        <span>Неизвестный артист</span>
                                                                    {% endif %}
                                                                </div>
                                                            </div>
                                                            <div class="stats-track-plays">{{ item.count }}</div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <div class="stats-empty">Нет прослушанных треков</div>
                                            {% endif %}
                                        </div>

                                        <!-- Топ артисты -->
                                        <div class="stats-card stats-card-artists">
                                            <div class="stats-card-header">
                                                <h3 class="stats-card-title">Топ артисты</h3>
                                                <span class="stats-card-count">{{ data.artists|length }}</span>
                                            </div>
                                            {% if data.artists %}
                                                <div class="stats-artists-list">
                                                    {% for item in data.artists %}
                                                        <div class="stats-artist-item">
                                                            <div class="stats-artist-rank">{{ forloop.counter }}</div>
                                                            {% if item.artist.image %}
                                                                <img class="stats-artist-avatar" src="{{ item.artist.image.url }}" alt="{{ item.artist.name }}">
                                                            {% else %}
                                                                <div class="stats-artist-avatar-placeholder">♪</div>
                                                            {% endif %}
                                                            <div class="stats-artist-info">
                                                                {% if item.artist.spotify_url %}
                                                                    <a href="{{ item.artist.spotify_url }}" target="_blank" class="stats-artist-name">{{ item.artist.name }}</a>
                                                                {% else %}
                                                                    <span class="stats-artist-name">{{ item.artist.name }}</span>
                                                                {% endif %}
                                                            </div>
                                                            <div class="stats-artist-plays">{{ item.count }}</div>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <div class="stats-empty">Нет данных по артистам</div>
                                            {% endif %}
                                        </div>

                                        <!-- Топ жанры -->
                                        <div class="stats-card stats-card-genres">
                                            <div class="stats-card-header">
                                                <h3 class="stats-card-title">Топ жанры</h3>
                                                <span class="stats-card-count">{{ data.genres|length }}</span>
                                            </div>
                                            {% if data.genres %}
                                                <div class="stats-genres-grid">
                                                    {% for item in data.genres %}
                                                        <div class="stats-genre-item">
                                                            <span class="stats-genre-name">{{ item.genre|default:"Без жанра" }}</span>
                                                            <span class="stats-genre-count">{{ item.count }}</span>
                                                        </div>
                                                    {% endfor %}
                                                </div>
                                            {% else %}
                                                <div class="stats-empty">Нет данных по жанрам</div>
                                            {% endif %}
                                        </div>
                                    </div>
                                </div>
                            {% endwith %}
                        {% endfor %}
                    </div>
                {% else %}
                    <div class="empty-state">
                        <p>Статистика пока не собрана</p>
                    </div>
                {% endif %}
            {% else %}
                <div class="empty-state">
                    <p>Подключите Spotify, чтобы увидеть вашу статистику</p>
                    <a href="{% url 'spotify_login' %}" class="spotify-connect-button">Подключить Spotify</a>
                </div>
            {% endif %}
        </div>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const tabButtons = document.querySelectorAll('.tab-button');
            const tabContents = document.querySelectorAll('.tab-content');

            tabButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const targetTab = this.getAttribute('data-tab');

                    // Убираем активный класс у всех кнопок и контента
                    tabButtons.forEach(btn => btn.classList.remove('active'));
                    tabContents.forEach(content => content.classList.remove('active'));

                    // Добавляем активный класс к выбранной кнопке и соответствующему контенту
                    this.classList.add('active');
                    document.getElementById(targetTab + '-tab').classList.add('active');
                });
            });

            // Обработка создания плейлиста
            const createPlaylistBtn = document.getElementById('create-playlist-btn');
            const playlistMessage = document.getElementById('playlist-message');

            if (createPlaylistBtn) {
                createPlaylistBtn.addEventListener('click', function() {
                    // Получаем CSRF токен
                    const csrftoken = document.querySelector('meta[name="csrf-token"]')?.getAttribute('content') || 
                                     getCookie('csrftoken');

                    // Отправляем POST запрос
                    fetch('{% url "create_spotify_playlist" %}', {
                        method: 'POST',
                        headers: {
                            'X-CSRFToken': csrftoken,
                            'Content-Type': 'application/json',
                        },
                        credentials: 'same-origin'
                    })
                    .then(response => {
                        if (response.ok) {
                            playlistMessage.textContent = 'Плейлист успешно создан!';
                            playlistMessage.className = 'playlist-message success';
                            playlistMessage.style.display = 'block';
                            
                            // Скрываем сообщение через 5 секунд
                            setTimeout(() => {
                                playlistMessage.style.display = 'none';
                            }, 5000);
                        } else {
                            playlistMessage.textContent = 'Ошибка при создании плейлиста';
                            playlistMessage.className = 'playlist-message error';
                            playlistMessage.style.display = 'block';
                            
                            setTimeout(() => {
                                playlistMessage.style.display = 'none';
                            }, 5000);
                        }
                    })
                    .catch(error => {
                        console.error('Error:', error);
                        playlistMessage.textContent = 'Ошибка при создании плейлиста';
                        playlistMessage.className = 'playlist-message error';
                        playlistMessage.style.display = 'block';
                        
                        setTimeout(() => {
                            playlistMessage.style.display = 'none';
                        }, 5000);
                    });
                });
            }

            // ===== Статистика: селекторы даты и фильтрация =====
            const statsContainer = document.getElementById('stats-container');
            const yearSelect = document.getElementById('stats-year');
            const monthSelect = document.getElementById('stats-month');
            const showAllBtn = document.getElementById('stats-show-all');

            if (statsContainer && yearSelect && monthSelect && showAllBtn) {
                const blocks = Array.from(statsContainer.querySelectorAll('.stats-period-block'));
                const yearsMap = new Map(); // year -> Set(monthNumbers)

                function toInt(v) { return parseInt(v, 10) || 0; }

                // Collect available years and months from DOM
                blocks.forEach(b => {
                    const y = toInt(b.getAttribute('data-year'));
                    const m = toInt(b.getAttribute('data-month'));
                    if (!yearsMap.has(y)) yearsMap.set(y, new Set());
                    yearsMap.get(y).add(m);
                });

                // Sort years desc
                const years = Array.from(yearsMap.keys()).filter(Boolean).sort((a, b) => b - a);

                // Populate year select
                yearSelect.innerHTML = '';
                years.forEach(y => {
                    const opt = document.createElement('option');
                    opt.value = String(y);
                    opt.textContent = String(y);
                    yearSelect.appendChild(opt);
                });

                function populateMonths(year) {
                    const set = yearsMap.get(year) || new Set();
                    const months = Array.from(set).sort((a, b) => b - a);
                    monthSelect.innerHTML = '';
                    months.forEach(m => {
                        const opt = document.createElement('option');
                        opt.value = String(m);
                        const monthNames = [
                            'Январь','Февраль','Март','Апрель','Май','Июнь',
                            'Июль','Август','Сентябрь','Октябрь','Ноябрь','Декабрь'
                        ];
                        const label = monthNames[(m - 1)] || String(m);
                        opt.textContent = label;
                        monthSelect.appendChild(opt);
                    });
                }

                function applyFilter() {
                    const y = toInt(yearSelect.value);
                    const m = toInt(monthSelect.value);
                    blocks.forEach(b => {
                        const by = toInt(b.getAttribute('data-year'));
                        const bm = toInt(b.getAttribute('data-month'));
                        b.style.display = (by === y && bm === m) ? '' : 'none';
                    });
                }

                function showAll() {
                    blocks.forEach(b => b.style.display = '');
                }

                // Default selection: last year/month available (desc sorted)
                let defaultYear = years[0];
                populateMonths(defaultYear);
                let defaultMonth = Array.from(yearsMap.get(defaultYear) || []).sort((a,b)=>b-a)[0];

                // Try to restore from localStorage if present and valid
                try {
                    const savedY = toInt(localStorage.getItem('statsYear'));
                    const savedM = toInt(localStorage.getItem('statsMonth'));
                    if (savedY && yearsMap.has(savedY) && yearsMap.get(savedY).has(savedM)) {
                        defaultYear = savedY;
                        populateMonths(defaultYear);
                        defaultMonth = savedM;
                    }
                } catch (e) {}

                yearSelect.value = String(defaultYear);
                monthSelect.value = String(defaultMonth);
                applyFilter();

                yearSelect.addEventListener('change', () => {
                    const y = toInt(yearSelect.value);
                    populateMonths(y);
                    // Choose the latest month for the selected year
                    const months = Array.from(yearsMap.get(y) || []).sort((a,b)=>b-a);
                    if (months.length) {
                        monthSelect.value = String(months[0]);
                    }
                    applyFilter();
                    try { localStorage.setItem('statsYear', String(y)); localStorage.setItem('statsMonth', String(monthSelect.value)); } catch (e) {}
                });

                monthSelect.addEventListener('change', () => {
                    applyFilter();
                    try { localStorage.setItem('statsYear', String(yearSelect.value)); localStorage.setItem('statsMonth', String(monthSelect.value)); } catch (e) {}
                });

                showAllBtn.addEventListener('click', () => {
                    showAll();
                });
            }

            // Функция для получения CSRF токена из cookies
            function getCookie(name) {
                let cookieValue = null;
                if (document.cookie && document.cookie !== '') {
                    const cookies = document.cookie.split(';');
                    for (let i = 0; i < cookies.length; i++) {
                        const cookie = cookies[i].trim();
                        if (cookie.substring(0, name.length + 1) === (name + '=')) {
                            cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                            break;
                        }
                    }
                }
                return cookieValue;
            }
        });
    </script>
</body>
</html>
