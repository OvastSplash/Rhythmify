from django.test import TestCase
from .spotify_data_service import ConstructSpotifyDataService, GenreClass
from typing import List
from django.contrib.auth import get_user_model
from SpotifyController.spotify_data_service import (
    TrackClass,
    ArtistClass,
)
from datetime import datetime
from django.utils import timezone
from SpotifyController.db_services import (
    SpotifyDatabaseService,
    GetSpotifyInfoFromDatabase,
)


User = get_user_model()

class ConstrucSpotifyDataServiceTest(TestCase):
    def test_construct_tracks_with_played_at(self):
        data = [{'track': {'album': {'album_type': 'single', 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/6s6HhNePAkax0mfTK1O57K'}, 'href': 'https://api.spotify.com/v1/artists/6s6HhNePAkax0mfTK1O57K', 'id': '6s6HhNePAkax0mfTK1O57K', 'name': 'pathetic240px', 'type': 'artist', 'uri': 'spotify:artist:6s6HhNePAkax0mfTK1O57K'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'external_urls': {'spotify': 'https://open.spotify.com/album/0Jqdj4cAMoEcdxLJuKeZWR'}, 'href': 'https://api.spotify.com/v1/albums/0Jqdj4cAMoEcdxLJuKeZWR', 'id': '0Jqdj4cAMoEcdxLJuKeZWR', 'images': [{'height': 640, 'url': 'https://i.scdn.co/image/ab67616d0000b273441470228cefd3bcb2b1a7c0', 'width': 640}, {'height': 300, 'url': 'https://i.scdn.co/image/ab67616d00001e02441470228cefd3bcb2b1a7c0', 'width': 300}, {'height': 64, 'url': 'https://i.scdn.co/image/ab67616d00004851441470228cefd3bcb2b1a7c0', 'width': 64}], 'name': 'Society', 'release_date': '2022-02-28', 'release_date_precision': 'day', 'total_tracks': 1, 'type': 'album', 'uri': 'spotify:album:0Jqdj4cAMoEcdxLJuKeZWR'}, 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/6s6HhNePAkax0mfTK1O57K'}, 'href': 'https://api.spotify.com/v1/artists/6s6HhNePAkax0mfTK1O57K', 'id': '6s6HhNePAkax0mfTK1O57K', 'name': 'pathetic240px', 'type': 'artist', 'uri': 'spotify:artist:6s6HhNePAkax0mfTK1O57K'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'disc_number': 1, 'duration_ms': 214062, 'explicit': False, 'external_ids': {'isrc': 'RUA1D2208096'}, 'external_urls': {'spotify': 'https://open.spotify.com/track/5NLdlIggmKj4G7RB6l8Tm1'}, 'href': 'https://api.spotify.com/v1/tracks/5NLdlIggmKj4G7RB6l8Tm1', 'id': '5NLdlIggmKj4G7RB6l8Tm1', 'is_local': False, 'name': 'Society', 'popularity': 62, 'preview_url': None, 'track_number': 1, 'type': 'track', 'uri': 'spotify:track:5NLdlIggmKj4G7RB6l8Tm1'}, 'played_at': '2025-11-28T02:58:30.156Z', 'context': {'external_urls': {'spotify': 'https://open.spotify.com/playlist/05iSS8SwquKiGx4tVO7g2a'}, 'href': 'https://api.spotify.com/v1/playlists/05iSS8SwquKiGx4tVO7g2a', 'type': 'playlist', 'uri': 'spotify:playlist:05iSS8SwquKiGx4tVO7g2a'}}, {'track': {'album': {'album_type': 'album', 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/09CJcG6ndtL82D8x9VxaeT'}, 'href': 'https://api.spotify.com/v1/artists/09CJcG6ndtL82D8x9VxaeT', 'id': '09CJcG6ndtL82D8x9VxaeT', 'name': 'SALEM', 'type': 'artist', 'uri': 'spotify:artist:09CJcG6ndtL82D8x9VxaeT'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'external_urls': {'spotify': 'https://open.spotify.com/album/6CNLfcQDhEtcu2Wr1ALPP0'}, 'href': 'https://api.spotify.com/v1/albums/6CNLfcQDhEtcu2Wr1ALPP0', 'id': '6CNLfcQDhEtcu2Wr1ALPP0', 'images': [{'height': 640, 'url': 'https://i.scdn.co/image/ab67616d0000b273577e621f0ecc8f95b12c065a', 'width': 640}, {'height': 300, 'url': 'https://i.scdn.co/image/ab67616d00001e02577e621f0ecc8f95b12c065a', 'width': 300}, {'height': 64, 'url': 'https://i.scdn.co/image/ab67616d00004851577e621f0ecc8f95b12c065a', 'width': 64}], 'name': 'King Night', 'release_date': '2010-09-28', 'release_date_precision': 'day', 'total_tracks': 12, 'type': 'album', 'uri': 'spotify:album:6CNLfcQDhEtcu2Wr1ALPP0'}, 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/09CJcG6ndtL82D8x9VxaeT'}, 'href': 'https://api.spotify.com/v1/artists/09CJcG6ndtL82D8x9VxaeT', 'id': '09CJcG6ndtL82D8x9VxaeT', 'name': 'SALEM', 'type': 'artist', 'uri': 'spotify:artist:09CJcG6ndtL82D8x9VxaeT'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'disc_number': 1, 'duration_ms': 199853, 'explicit': False, 'external_ids': {'isrc': 'US53Q0900051'}, 'external_urls': {'spotify': 'https://open.spotify.com/track/4LKOq3cE1spOOLbB3wOx86'}, 'href': 'https://api.spotify.com/v1/tracks/4LKOq3cE1spOOLbB3wOx86', 'id': '4LKOq3cE1spOOLbB3wOx86', 'is_local': False, 'name': 'Sick', 'popularity': 40, 'preview_url': None, 'track_number': 4, 'type': 'track', 'uri': 'spotify:track:4LKOq3cE1spOOLbB3wOx86'}, 'played_at': '2025-11-28T02:54:55.333Z', 'context': {'external_urls': {'spotify': 'https://open.spotify.com/playlist/05iSS8SwquKiGx4tVO7g2a'}, 'href': 'https://api.spotify.com/v1/playlists/05iSS8SwquKiGx4tVO7g2a', 'type': 'playlist', 'uri': 'spotify:playlist:05iSS8SwquKiGx4tVO7g2a'}}, {'track': {'album': {'album_type': 'single', 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/7CV3dQkhJB2dEqb85ICD33'}, 'href': 'https://api.spotify.com/v1/artists/7CV3dQkhJB2dEqb85ICD33', 'id': '7CV3dQkhJB2dEqb85ICD33', 'name': 'Snow Wife', 'type': 'artist', 'uri': 'spotify:artist:7CV3dQkhJB2dEqb85ICD33'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'external_urls': {'spotify': 'https://open.spotify.com/album/4wYQOo4tyBBbKL7ygZNgI3'}, 'href': 'https://api.spotify.com/v1/albums/4wYQOo4tyBBbKL7ygZNgI3', 'id': '4wYQOo4tyBBbKL7ygZNgI3', 'images': [{'height': 640, 'url': 'https://i.scdn.co/image/ab67616d0000b273276e052630b0698baec01b7b', 'width': 640}, {'height': 300, 'url': 'https://i.scdn.co/image/ab67616d00001e02276e052630b0698baec01b7b', 'width': 300}, {'height': 64, 'url': 'https://i.scdn.co/image/ab67616d00004851276e052630b0698baec01b7b', 'width': 64}], 'name': 'Crazy', 'release_date': '2024-09-13', 'release_date_precision': 'day', 'total_tracks': 1, 'type': 'album', 'uri': 'spotify:album:4wYQOo4tyBBbKL7ygZNgI3'}, 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/7CV3dQkhJB2dEqb85ICD33'}, 'href': 'https://api.spotify.com/v1/artists/7CV3dQkhJB2dEqb85ICD33', 'id': '7CV3dQkhJB2dEqb85ICD33', 'name': 'Snow Wife', 'type': 'artist', 'uri': 'spotify:artist:7CV3dQkhJB2dEqb85ICD33'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'disc_number': 1, 'duration_ms': 145613, 'explicit': True, 'external_ids': {'isrc': 'QMBZ92438642'}, 'external_urls': {'spotify': 'https://open.spotify.com/track/62ptJWdV7qRJ4CbYPc56SB'}, 'href': 'https://api.spotify.com/v1/tracks/62ptJWdV7qRJ4CbYPc56SB', 'id': '62ptJWdV7qRJ4CbYPc56SB', 'is_local': False, 'name': 'Crazy', 'popularity': 48, 'preview_url': None, 'track_number': 1, 'type': 'track', 'uri': 'spotify:track:62ptJWdV7qRJ4CbYPc56SB'}, 'played_at': '2025-11-28T02:51:35.239Z', 'context': {'external_urls': {'spotify': 'https://open.spotify.com/playlist/05iSS8SwquKiGx4tVO7g2a'}, 'href': 'https://api.spotify.com/v1/playlists/05iSS8SwquKiGx4tVO7g2a', 'type': 'playlist', 'uri': 'spotify:playlist:05iSS8SwquKiGx4tVO7g2a'}}, {'track': {'album': {'album_type': 'single', 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/0XFgyr4jwM0MGeZZW0VzA5'}, 'href': 'https://api.spotify.com/v1/artists/0XFgyr4jwM0MGeZZW0VzA5', 'id': '0XFgyr4jwM0MGeZZW0VzA5', 'name': 'DVRST', 'type': 'artist', 'uri': 'spotify:artist:0XFgyr4jwM0MGeZZW0VzA5'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'external_urls': {'spotify': 'https://open.spotify.com/album/3G0b8ob9anYQl8a1t3GpOF'}, 'href': 'https://api.spotify.com/v1/albums/3G0b8ob9anYQl8a1t3GpOF', 'id': '3G0b8ob9anYQl8a1t3GpOF', 'images': [{'height': 640, 'url': 'https://i.scdn.co/image/ab67616d0000b27311447aead485afd7c57aa042', 'width': 640}, {'height': 300, 'url': 'https://i.scdn.co/image/ab67616d00001e0211447aead485afd7c57aa042', 'width': 300}, {'height': 64, 'url': 'https://i.scdn.co/image/ab67616d0000485111447aead485afd7c57aa042', 'width': 64}], 'name': 'Close Eyes', 'release_date': '2021-05-25', 'release_date_precision': 'day', 'total_tracks': 1, 'type': 'album', 'uri': 'spotify:album:3G0b8ob9anYQl8a1t3GpOF'}, 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/0XFgyr4jwM0MGeZZW0VzA5'}, 'href': 'https://api.spotify.com/v1/artists/0XFgyr4jwM0MGeZZW0VzA5', 'id': '0XFgyr4jwM0MGeZZW0VzA5', 'name': 'DVRST', 'type': 'artist', 'uri': 'spotify:artist:0XFgyr4jwM0MGeZZW0VzA5'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'disc_number': 1, 'duration_ms': 132346, 'explicit': True, 'external_ids': {'isrc': 'QZHN82186053'}, 'external_urls': {'spotify': 'https://open.spotify.com/track/3CLSHJv5aUROAN2vfOyCOh'}, 'href': 'https://api.spotify.com/v1/tracks/3CLSHJv5aUROAN2vfOyCOh', 'id': '3CLSHJv5aUROAN2vfOyCOh', 'is_local': False, 'name': 'Close Eyes', 'popularity': 71, 'preview_url': None, 'track_number': 1, 'type': 'track', 'uri': 'spotify:track:3CLSHJv5aUROAN2vfOyCOh'}, 'played_at': '2025-11-28T02:49:20.047Z', 'context': {'external_urls': {'spotify': 'https://open.spotify.com/playlist/05iSS8SwquKiGx4tVO7g2a'}, 'href': 'https://api.spotify.com/v1/playlists/05iSS8SwquKiGx4tVO7g2a', 'type': 'playlist', 'uri': 'spotify:playlist:05iSS8SwquKiGx4tVO7g2a'}}, {'track': {'album': {'album_type': 'album', 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/3wrFoI9EVjWg6m8xXeWr5t'}, 'href': 'https://api.spotify.com/v1/artists/3wrFoI9EVjWg6m8xXeWr5t', 'id': '3wrFoI9EVjWg6m8xXeWr5t', 'name': 'VALORANT', 'type': 'artist', 'uri': 'spotify:artist:3wrFoI9EVjWg6m8xXeWr5t'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'external_urls': {'spotify': 'https://open.spotify.com/album/25j6HJglfSOeTMzm5ltSyj'}, 'href': 'https://api.spotify.com/v1/albums/25j6HJglfSOeTMzm5ltSyj', 'id': '25j6HJglfSOeTMzm5ltSyj', 'images': [{'height': 640, 'url': 'https://i.scdn.co/image/ab67616d0000b27304802a3a9e155e4eaed25520', 'width': 640}, {'height': 300, 'url': 'https://i.scdn.co/image/ab67616d00001e0204802a3a9e155e4eaed25520', 'width': 300}, {'height': 64, 'url': 'https://i.scdn.co/image/ab67616d0000485104802a3a9e155e4eaed25520', 'width': 64}], 'name': 'VALORANT Sounds, Vol. 1', 'release_date': '2024-08-28', 'release_date_precision': 'day', 'total_tracks': 12, 'type': 'album', 'uri': 'spotify:album:25j6HJglfSOeTMzm5ltSyj'}, 'artists': [{'external_urls': {'spotify': 'https://open.spotify.com/artist/3wrFoI9EVjWg6m8xXeWr5t'}, 'href': 'https://api.spotify.com/v1/artists/3wrFoI9EVjWg6m8xXeWr5t', 'id': '3wrFoI9EVjWg6m8xXeWr5t', 'name': 'VALORANT', 'type': 'artist', 'uri': 'spotify:artist:3wrFoI9EVjWg6m8xXeWr5t'}, {'external_urls': {'spotify': 'https://open.spotify.com/artist/4fv1OFJywZ7DHCz3mVQQ45'}, 'href': 'https://api.spotify.com/v1/artists/4fv1OFJywZ7DHCz3mVQQ45', 'id': '4fv1OFJywZ7DHCz3mVQQ45', 'name': 'Grabbitz', 'type': 'artist', 'uri': 'spotify:artist:4fv1OFJywZ7DHCz3mVQQ45'}], 'available_markets': ['AR', 'AU', 'AT', 'BE', 'BO', 'BR', 'BG', 'CA', 'CL', 'CO', 'CR', 'CY', 'CZ', 'DK', 'DO', 'DE', 'EC', 'EE', 'SV', 'FI', 'FR', 'GR', 'GT', 'HN', 'HK', 'HU', 'IS', 'IE', 'IT', 'LV', 'LT', 'LU', 'MY', 'MT', 'MX', 'NL', 'NZ', 'NI', 'NO', 'PA', 'PY', 'PE', 'PH', 'PL', 'PT', 'SG', 'SK', 'ES', 'SE', 'CH', 'TW', 'TR', 'UY', 'US', 'GB', 'AD', 'LI', 'MC', 'ID', 'JP', 'TH', 'VN', 'RO', 'IL', 'ZA', 'SA', 'AE', 'BH', 'QA', 'OM', 'KW', 'EG', 'MA', 'DZ', 'TN', 'LB', 'JO', 'PS', 'IN', 'BY', 'KZ', 'MD', 'UA', 'AL', 'BA', 'HR', 'ME', 'MK', 'RS', 'SI', 'KR', 'BD', 'PK', 'LK', 'GH', 'KE', 'NG', 'TZ', 'UG', 'AG', 'AM', 'BS', 'BB', 'BZ', 'BT', 'BW', 'BF', 'CV', 'CW', 'DM', 'FJ', 'GM', 'GE', 'GD', 'GW', 'GY', 'HT', 'JM', 'KI', 'LS', 'LR', 'MW', 'MV', 'ML', 'MH', 'FM', 'NA', 'NR', 'NE', 'PW', 'PG', 'PR', 'WS', 'SM', 'ST', 'SN', 'SC', 'SL', 'SB', 'KN', 'LC', 'VC', 'SR', 'TL', 'TO', 'TT', 'TV', 'VU', 'AZ', 'BN', 'BI', 'KH', 'CM', 'TD', 'KM', 'GQ', 'SZ', 'GA', 'GN', 'KG', 'LA', 'MO', 'MR', 'MN', 'NP', 'RW', 'TG', 'UZ', 'ZW', 'BJ', 'MG', 'MU', 'MZ', 'AO', 'CI', 'DJ', 'ZM', 'CD', 'CG', 'IQ', 'LY', 'TJ', 'VE', 'ET', 'XK'], 'disc_number': 1, 'duration_ms': 212926, 'explicit': False, 'external_ids': {'isrc': 'QZH6S1900411'}, 'external_urls': {'spotify': 'https://open.spotify.com/track/0EIiEUREYnDRHbWKP55o4F'}, 'href': 'https://api.spotify.com/v1/tracks/0EIiEUREYnDRHbWKP55o4F', 'id': '0EIiEUREYnDRHbWKP55o4F', 'is_local': False, 'name': 'Die For You', 'popularity': 66, 'preview_url': None, 'track_number': 10, 'type': 'track', 'uri': 'spotify:track:0EIiEUREYnDRHbWKP55o4F'}, 'played_at': '2025-11-28T02:46:55.925Z', 'context': {'external_urls': {'spotify': 'https://open.spotify.com/playlist/05iSS8SwquKiGx4tVO7g2a'}, 'href': 'https://api.spotify.com/v1/playlists/05iSS8SwquKiGx4tVO7g2a', 'type': 'playlist', 'uri': 'spotify:playlist:05iSS8SwquKiGx4tVO7g2a'}}]
        construct_sp = ConstructSpotifyDataService()
        construct_sp.construct_tracks_data_with_played_at(data)

class UserHistoryTrackStatisticsServiceTest(TestCase):
    def setUp(self):
        self.user = get_user_model().objects.create_user(username='test', user_login="test", password='test_password')
        self.tracks_class: List[TrackClass] = list()

        for i in range(12):
            played_at = datetime(2025, 1, 1, 0, 0, 0)
            played_at = timezone.make_aware(played_at, timezone.get_current_timezone())

            genres = [GenreClass(name=f"Genre {i}") for i in range(5)]

            artist = [ArtistClass(
                name=f"Artist {i}",
                spotify_id = f"spotify:artist:{i}",
                spotify_url = f"spotify:artist:{i}",
                genres = genres,
            )]

            track = TrackClass(
                name=f"test_name_{i}",
                url=f"https://open.spotify.com/track/{i}",
                spotify_id=f"spotify:track:{i}",
                played_at=played_at,
                artists=artist,
            )
            self.tracks_class.append(track)


        played_at = datetime(2025, 1, 1, 0, 0, 0)
        played_at = timezone.make_aware(played_at, timezone.get_current_timezone())

        genres = [GenreClass(name=f"Genre {654}") for _ in range(5)]

        artist = [ArtistClass(
            name=f"Artist {i}",
            spotify_id=f"spotify:artist:{i}",
            spotify_url=f"spotify:artist:{i}",
            genres=genres,
        ) for i in range(2)]

        track = TrackClass(
            name=f"test_name_{2}",
            url=f"https://open.spotify.com/track/{1}",
            spotify_id=f"spotify:track:{1}",
            played_at=played_at,
            artists=artist,
        )

        self.tracks_class.append(track)

    def test_user_history_to_obj(self):
        print("Start check")

        sp_db = SpotifyDatabaseService()
        tracks = sp_db.create_played_at_tracks(self.tracks_class)
        sp_db.save_user_listen_tracks_history(user=self.user, tracks=tracks)

        get_sp_db = GetSpotifyInfoFromDatabase(self.user)
        user_statistics_data = get_sp_db.get_user_listen_statistic()
        get_sp_db.convert_user_statistic(user_statistics_data)